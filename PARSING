


CREATE TABLE general_data AS
WITH raw AS (
    SELECT
        UNNEST(games) as general_data
    FROM read_json_auto('steam_2025.json', maximum_object_size=107000000)
)
SELECT
    CAST(json_extract(general_data, '$.appid') AS INTEGER) as app_id,
    json_extract_string(general_data, '$.name_from_applist') as name,
    CAST(json_extract(general_data, '$.app_details.data.steam_appid') AS INTEGER) as steam_appid,
    json_extract_string(general_data, '$.app_details.data.name') as game_name,
    json_extract_string(general_data, '$.app_details.data.type' ) AS game_type,
    CAST(json_extract_string(general_data, '$.app_details.data.is_free') AS BOOLEAN) as freeness,
    CAST(json_extract_string(general_data, '$.app_details.data.required_age') AS INTEGER) as age_reg,
    CASE
        WHEN json_extract_string(general_data, '$.app_details.data.release_date.date')
             ~ '^[A-Za-z]{3} [0-9]{1,2}, [0-9]{4}$'
        THEN STRPTIME(
            json_extract_string(general_data, '$.app_details.data.release_date.date'),
            '%b %d, %Y'
        )
        ELSE NULL
    END AS data_ready,

    CAST(json_extract_string(general_data, '$.app_details.data.platforms.windows') AS BOOLEAN) AS windows,
    CAST(json_extract_string(general_data, '$.app_details.data.platforms.mac') AS BOOLEAN) AS mac,
    CAST(json_extract_string(general_data, '$.app_details.data.platforms.linux') AS BOOLEAN) AS linux,

    CAST(json_extract(general_data, '$.app_details.data.price_overview.final') AS DOUBLE) / 100 as price_final,

    json_extract(general_data, '$.app_details.data.publishers') AS publisher,
 json_extract_string(gen.value, '$.description') AS genre,
 pub.value::VARCHAR AS publisher

FROM raw;




CREATE TABLE gen AS
SELECT app_id,
    json_extract_string(g.value, '$.description') AS genre
FROM general_data,
json_each(genre) AS g
WHERE genre IS NOT NULL;

select * from gen;


CREATE TABLE publishers AS
SELECT
    app_id, p.value::VARCHAR AS publisher
FROM general_data,
json_each(publisher) AS p
WHERE publisher IS NOT NULL;


SELECT * from publishers;









select * from general_data;

